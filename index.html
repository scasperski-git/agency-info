<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agency Contact Info Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body { height:100%; margin:0; }
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #eef1f4, #f4f6f8);
  padding: 20px;
}
.container {
  max-width: 420px;
  margin: auto;
  background: #fff;
  padding: 16px 20px 20px;
  border-radius: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
}
h2 { text-align:center; margin:0 0 8px; }
label { font-weight:bold; }
input {
  width:100%; padding:10px; margin:5px 0 4px;
  border:1px solid #ccc; border-radius:5px;
  text-transform:uppercase;
}
.error { border-color:#e53935; background:#fff5f5; }
.errorText { font-size:12px; color:#e53935; display:none; }
.consent { font-size:13px; margin:10px 0; }
button {
  width:100%; padding:12px;
  background:#1e88e5; color:#fff;
  border:none; border-radius:5px;
  font-size:16px; opacity:.6; cursor:not-allowed;
}
button.enabled { opacity:1; cursor:pointer; }
.helper { font-size:12px; text-align:center; color:#777; }
.success { display:none; text-align:center; }
</style>
</head>

<body>

<div class="container" id="formBox">
<h2>ðŸ“„ AGENCY CONTACT INFO</h2>

<form onsubmit="return submitForm();">

<label>Agency Name *</label>
<input type="text" id="agency">
<div class="errorText" id="err_agency">Required</div>

<label>PIC Name 1 *</label>
<input type="text" id="pic1">
<div class="errorText" id="err_pic1">Required</div>

<label>PIC Name 2</label>
<input type="text" id="pic2">

<label>Contact No *</label>
<input type="tel" id="contact1" oninput="formatPhone(this)">
<div class="errorText" id="err_contact1">Required</div>

<label>Contact No (Optional)</label>
<input type="tel" id="contact2" oninput="formatPhone(this)">

<label>WhatsApp No *</label>
<input type="tel" id="whatsapp" oninput="formatPhone(this)">
<div class="errorText" id="err_whatsapp">Required</div>

<div class="consent">
<input type="checkbox" id="consent" onclick="updateState()">
I confirm the information is accurate
</div>

<button id="submitBtn">Submit</button>
<div class="helper" id="helperText"></div>

</form>
</div>

<div class="container success" id="successBox">
<h2>âœ… Submission Successful</h2>
<p id="refDisplay"></p>
<p>You may close this page.</p>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUej6006JnB65NObWL-FzOT_Kyv5PSbOk3OlXM9mb1BtlBAuS2ayqCG2xSvroduw0B/exec";

const mandatory = [
 {id:"agency",err:"err_agency"},
 {id:"pic1",err:"err_pic1"},
 {id:"contact1",err:"err_contact1"},
 {id:"whatsapp",err:"err_whatsapp"}
];

function formatPhone(el){
 let v = el.value.replace(/\D/g,"");
 if(v.startsWith("0")) v="6"+v;
 if(!v.startsWith("6")) v="6"+v;
 el.value=v;
}

function updateState(){
 let ok=true;
 mandatory.forEach(f=>{
  let i=document.getElementById(f.id);
  let e=document.getElementById(f.err);
  if(!i.value.trim()){
   ok=false; i.classList.add("error"); e.style.display="block";
  } else {
   i.classList.remove("error"); e.style.display="none";
  }
 });
 submitBtn.disabled=!ok||!consent.checked;
 submitBtn.classList.toggle("enabled",!submitBtn.disabled);
}

mandatory.forEach(f=>{
 document.getElementById(f.id).addEventListener("input",updateState);
});

function generateRef(){
 let d=new Date();
 return "AGY-"+d.getTime();
}

async function submitForm(){
 updateState();
 if(submitBtn.disabled) return false;

 const agencyName = agency.value.toUpperCase().trim();
 const agencyKey = agencyName.split(" ")[0];

 const check = await fetch(
   SCRIPT_URL+"?action=check&key="+encodeURIComponent(agencyKey)
 );
 const checkResult = await check.text();

 if(checkResult==="BLOCKED"){
   alert("This agency record has already been updated once.\nFurther updates are not allowed.");
   return false;
 }

 if(checkResult==="EXISTS"){
   if(!confirm(
     "This agency already exists.\n\nDo you want to update the record?\n\nUpdate is allowed only once."
   )) return false;
 }

 const data = new URLSearchParams();
 data.append("ref",generateRef());
 data.append("agency",agencyName);
 data.append("pic1",pic1.value.toUpperCase());
 data.append("pic2",pic2.value.toUpperCase());
 data.append("contact1",contact1.value);
 data.append("contact2",contact2.value);
 data.append("whatsapp",whatsapp.value);
 data.append("consent","YES");

 const resp = await fetch(SCRIPT_URL,{method:"POST",body:data});
 const result = await resp.text();

 if(result==="BLOCKED"){
   alert("Update not allowed.");
   return false;
 }

 formBox.style.display="none";
 successBox.style.display="block";
 refDisplay.innerText="Reference No: "+data.get("ref");

 return false;
}
</script>

</body>
</html>
